name: Deploy to EC2

on:
  push:
    branches:
      - main  # 프로덕션 배포
      - dev   # 개발 환경 배포

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "SPRING_PROFILES_ACTIVE=prod" >> $GITHUB_ENV
            echo "APPLICATION_NAME=kickon-prod" >> $GITHUB_ENV
            echo "DEPLOYMENT_GROUP=kickon-prod-group" >> $GITHUB_ENV
          else
            echo "SPRING_PROFILES_ACTIVE=dev" >> $GITHUB_ENV
            echo "APPLICATION_NAME=kickon-dev" >> $GITHUB_ENV
            echo "DEPLOYMENT_GROUP=kickon-dev-group" >> $GITHUB_ENV
          fi

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Move JAR to root
        run: cp build/libs/*.jar kickon.jar

      # ==========================
      # DEV: Docker 이미지 빌드 & ECR 푸시
      # ==========================
      - name: Configure AWS credentials
        if: env.SPRING_PROFILES_ACTIVE == 'dev'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        if: env.SPRING_PROFILES_ACTIVE == 'dev'
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
          | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build & Push Docker image (dev)
        if: env.SPRING_PROFILES_ACTIVE == 'dev'
        run: |
          docker build --build-arg SPRING_PROFILES_ACTIVE=dev -t kickon-backend-dev .
          docker tag kickon-backend-dev:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/kickon-backend-dev:latest
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/kickon-backend-dev:latest

      # ==========================
      # DEV: EC2에서 Docker 컨테이너 실행
      # ==========================
      - name: Deploy to EC2 (dev)
        if: env.SPRING_PROFILES_ACTIVE == 'dev'
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST_DEV }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY_DEV }}
          script: |
            CONTAINER_NAME="kickon-backend-dev"
            IMAGE="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com/kickon-backend-dev:latest"

            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true
            sudo docker pull $IMAGE

            # GitHub Secrets → 컨테이너 환경변수 주입
            sudo docker run -d --name $CONTAINER_NAME -p 8081:8080 \
              -e SPRING_PROFILES_ACTIVE=dev \
              -e AWS_REGION=ap-northeast-2 \
              -e JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} \
              -e ADMIN_JWT_SECRET_KEY=${{ secrets.ADMIN_JWT_SECRET_KEY }} \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e KAKAO_CLIENT=${{ secrets.KAKAO_CLIENT }} \
              -e KAKAO_SECRET=${{ secrets.KAKAO_SECRET }} \
              -e KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }} \
              -e NAVER_CLIENT=${{ secrets.NAVER_CLIENT }} \
              -e NAVER_SECRET=${{ secrets.NAVER_SECRET }} \
              -e NAVER_REDIRECT_URI=${{ secrets.NAVER_REDIRECT_URI }} \
              -e API_SPORTS_KEY=${{ secrets.API_SPORTS_KEY }} \
              -e API_SLACK_KEY=${{ secrets.API_SLACK_KEY }} \
              $IMAGE

      # ==========================
      # PROD: 기존 CodeDeploy 배포
      # ==========================
      - name: Copy appspec.yml
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: cp appspec/appspec-${{env.SPRING_PROFILES_ACTIVE}}.yml appspec.yml

      - name: Copy application.yml
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: cp src/main/resources/application-${{env.SPRING_PROFILES_ACTIVE}}.yml application-${{env.SPRING_PROFILES_ACTIVE}}.yml

      - name: Copy scripts
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: mkdir -p scripts && cp -r ${{env.SPRING_PROFILES_ACTIVE}}-scripts/* scripts/

      - name: Package files for deployment
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: |
          mkdir -p deploy
          cp application-${{env.SPRING_PROFILES_ACTIVE}}.yml deploy/
          cp appspec.yml deploy/
          cp -r scripts deploy/
          cp build/libs/*.jar deploy/

      - name: Compress deployment package
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: zip -r deploy.zip deploy/

      - name: Upload zip to S3
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: |
          aws s3 cp deploy.zip s3://${{ secrets.S3_BUCKET }}/deploy/${{env.SPRING_PROFILES_ACTIVE}}.zip

      - name: Deploy with CodeDeploy
        if: env.SPRING_PROFILES_ACTIVE == 'prod'
        run: |
          aws deploy create-deployment \
          --application-name ${{ env.APPLICATION_NAME }} \
          --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
          --s3-location bucket=${{ secrets.S3_BUCKET }},bundleType=zip,key=deploy/${{env.SPRING_PROFILES_ACTIVE}}.zip
